#make TARGET=myapp ë“±ìœ¼ë¡œ ì´ë¦„ì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ main ì ìš©
TARGET ?= main
MODE ?= debug

# ANSI Escape Codeë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
GREEN  = \033[0;32m
CYAN   = \033[0;36m
YELLOW = \033[0;33m
RED    = \033[0;31m
RESET  = \033[0m


SRCDIR = source
BUILDDIR = build

#ìµœì¢… ì¶œë ¥ íŒŒì¼ bin, elf
BIN = $(BUILDDIR)/$(TARGET).bin
ELF = $(BUILDDIR)/$(TARGET).elf

#ë§í¬ì‹œ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ì„ í†µì§¸ë¡œ ì „ë‹¬í•˜ê¸° *.c íŒŒì¼ë¡œ ë¶€í„° *.o íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¬¸ìžì—´ í˜•íƒœë¡œ ë½‘ì•„ë‚¸ë‹¤.
#patsubstë¡œ ì¹˜í™˜ì‹œ %ë¡œ ì²˜ë¦¬í•¨ì— ìœ ì˜
SRCS = $(wildcard $(SRCDIR)/*.c)
OBJS = $(patsubst $(SRCDIR)/%.c, $(BUILDDIR)/%.o, $(SRCS))

#ì»´íŒŒì¼ëŸ¬,ë§ì»¤ ì„¤ì •
CC = arm-none-eabi-gcc
LD = arm-none-eabi-ld
OC = arm-none-eabi-objcopy


#ì»´íŒŒì¼ëŸ¬ì˜µì…˜
#ê³µí†µ
CFLAGS = -mcpu=cortex-m4 -mthumb -Wall

#debug, releashì— ë”°ë¼ ë‹¤ë¥´ê²Œ
ifeq ($(MODE), debug)
	CFLAGS += -g -O0 -DDEBUG
	MODE_MSG = "DEBUG MODE"
else
	CFLAGS += -Os -DNDEBUG
	MODE_MSG = "RELEASE MODE"
endif


#ë§ì»¤ ì˜µì…˜
LDSCRIPT = $(SRCDIR)/tm4c123.ld
LDFLAGS = -T $(LDSCRIPT)
OCFLAGS = -O binary


#ë¹Œë“œ ì •ë³´ë¥¼ ì¶œë ¥
BUILD_TIME  := $(shell date "+%Y-%m-%d %H:%M:%S")
GCC_VERSION := $(shell $(CC) -dumpversion)
SRC_COUNT   := $(words $(SRCS))

#Git ì •ë³´ ì¶”ì¶œ (ì£¼ìš” ë³€ê²½ì  ìš”ì•½)
# - ë³€ê²½ëœ íŒŒì¼ ê°œìˆ˜ì™€ ê°„ëžµí•œ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
GIT_BRANCH  := $(shell git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "Not a Git Repo")
GIT_CHANGES := $(shell git diff --shortstat 2>/dev/null || echo "No changes")
# ìˆ˜ì •ëœ íŒŒì¼ ì´ë¦„ë“¤ ì¤‘ ìƒìœ„ 3ê°œë§Œ ì¶”ì¶œ (ë„ˆë¬´ ë§Žì•„ì§€ëŠ” ê²ƒ ë°©ì§€)

GIT_FILES   := $(shell git diff --name-only 2>/dev/null | head -n 3 | tr '\n' ' ')


#ìµœì¢…ì ìœ¼ë¡œ biníŒŒì¼ì„ ë§Œë“¤ê±°ë‹¤
# ì•„ëž˜ì²˜ëŸ¼ í•˜ë©´ printinfo->BINë§Œë“¤ê³ ->check_size->down_ti ë¥¼ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•œë‹¤.
all: printinfo $(BIN) check_size down_ti


#ê·¸ëƒ¥ makeë§Œ ì¹˜ë©´ down íƒ€ê²Ÿìœ¼ë¡œ ì§„í–‰ëœë‹¤.
down_ti: printinfo $(BIN) check_size
	@echo ""
	@echo "$(YELLOW)Downloading ... : $(BIN) $(RESET)"
	sudo lm4flash $(BIN)
	@echo "$(CYAN)OK$(RESET)"
	@echo ""


down_st: printinfo $(BIN) check_size
	@echo ""
	@echo "$(YELLOW)Downloading ... : $(BIN) $(RESET)"
	sudo st-flash write $(BUILDDIR)/main.bin 0x8000000
	@echo "$(CYAN)OK$(RESET)"
	@echo ""






# [ì •ë³´ ì¶œë ¥] ë‹¤ë‹ˆì—˜ë‹˜ì˜ ìŠ¤íƒ€ì¼ + Git ì •ë³´ ì¶”ê°€
printinfo:
	@echo ""
	@echo "==============================================================================="
	@echo " [$(MODE)] PROCESS STARTED"
	@echo "==============================================================================="
	@echo "  Target Name  : $(TARGET).bin"
	@echo "  Build Mode   : $(MODE)"
	@echo "  GCC Version  : $(GCC_VERSION)"
	@echo "  Source Files : $(SRC_COUNT) files"
	@echo "  Linker Script: $(LDSCRIPT)"
	@echo "  Build Time   : $(BUILD_TIME)"
	@echo "  Output Path  : $(BUILDDIR)"
	@echo "  Git Changes  : $(GIT_CHANGES)"
	@echo "  Modified     : $(GIT_FILES)..."
	@echo "==============================================================================="


# 1. ì¹© ì‚¬ì–‘ ì„¤ì • (TM4C123GH6PM ê¸°ì¤€)
SIZE = arm-none-eabi-size
FLASH_SIZE = 262144  # 256 KB
RAM_SIZE   = 32768   # 32 KB

# ... ê¸°ì¡´ ì„¤ì •ë“¤ ...

# [SIZE] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìƒì„¸ ë¶„ì„
check_size: $(ELF)
	@echo ""
	@echo "$(YELLOW)>> Memory Usage Analysis: $(RESET)"
	@$(SIZE) $<
	@echo "==============================================================================="
	@$(eval TEXT := $(shell $(SIZE) $< | awk 'NR==2 {print $$1}'))
	@$(eval DATA := $(shell $(SIZE) $< | awk 'NR==2 {print $$2}'))
	@$(eval BSS  := $(shell $(SIZE) $< | awk 'NR==2 {print $$3}'))
	@$(eval FLASH_USED := $(shell echo $$(($(TEXT) + $(DATA)))))
	@$(eval RAM_USED   := $(shell echo $$(($(DATA) + $(BSS)))))
	@$(eval FLASH_FREE := $(shell echo $$(($(FLASH_SIZE) - $(FLASH_USED)))))
	@$(eval RAM_FREE   := $(shell echo $$(($(RAM_SIZE) - $(RAM_USED)))))
	@$(eval FLASH_PCT  := $(shell echo $$(($(FLASH_USED) * 100 / $(FLASH_SIZE)))))
	@$(eval RAM_PCT    := $(shell echo $$(($(RAM_USED) * 100 / $(RAM_SIZE)))))
	@echo "  Flash: $(FLASH_USED) / $(FLASH_SIZE) bytes ($(FLASH_PCT)%)"
	@echo "         Remaining: $(FLASH_FREE) bytes"
	@echo "  RAM:   $(RAM_USED) / $(RAM_SIZE) bytes ($(RAM_PCT)%)"
	@echo "         Remaining: $(RAM_FREE) bytes"
	@echo "==============================================================================="


# # # [SIZE] ë©”ëª¨ë¦¬ ì ìœ ìœ¨ í™•ì¸ (ìž„ë² ë””ë“œ í•„ìˆ˜)
# SIZE = arm-none-eabi-size
# check_size: $(ELF)
# 	@echo ""
# 	@echo ">> Memory Usage Summary:"
# 	@$(SIZE) $<
# 	@echo "==============================================================================="



#ìœ„ binì„ ë§Œë“¤ë ¤ë©´ , elfê°€ í•„ìš”í•˜ë‹¤ == objcopy
$(BIN): $(ELF)
	@echo ""
	@echo "$(YELLOW)Creating Binary...: $@ $(RESET)"
	$(OC) $(OCFLAGS) $< $@
	@echo "$(CYAN)OK$(RESET)"

#ìœ„ elfë¥¼ ë§Œë“¤ë ¤ë©´ objs íŒŒì¼ë“¤ì´ í•„ìš”í•˜ë‹¤ == Linking
$(ELF): $(OBJS)
	@echo ""
	@echo "$(YELLOW)Linking...: $@$(RESET)"
	$(LD) $(LDFLAGS) $^ -o $@ 
	@echo "$(CYAN)OK$(RESET)"

#ìœ„ objs íŒŒì¼ì„ ë§Œë“œëŠ” ë°©ë²•ì´ë‹¤ == compile 
#objsì•ˆì— ë“¤ì–´ìžˆëŠ” íŒŒì¼ë§Œ ë§Œë“ ë‹¤. #ì¦‰ ìœ„ì—ì„œ ì œì™¸ì²˜ë¦¬(filtered-out) í•œ íŒŒì¼ì€ ìžë™ìœ¼ë¡œ í¬í•¨ë˜ì§€ ì•ŠëŠ”ë‹¤
$(BUILDDIR)/%.o: $(SRCDIR)/%.c
	@echo ""
	@echo "$(YELLOW)Compile...: $< to $@ $(RESET)"
	@echo "$(CYAN)ðŸ” Changes in $<:$(RESET)"
	@# --word-diff-regexë¥¼ ì¨ì„œ ë³€ê²½ëœ ë¶€ë¶„ë§Œ ê°•ì¡°í•˜ê³ , ë¶ˆí•„ìš”í•œ í—¤ë”ëŠ” tailë¡œ ë‚ ë¦½ë‹ˆë‹¤.
	@git diff --color=always -U0 $< | tail -n +5 | head -n 5 || true
	@echo "$(CYAN)----------------------$(RESET)"
	@mkdir -p $(BUILDDIR)
	$(CC) $(CFLAGS) -c $< -o $@
	@echo "$(CYAN)OK$(RESET)"

# $(BUILDDIR)/%.o: $(SRCDIR)/%.c
# 	@echo ""
# 	@echo "$(YELLOW)Compile...: $< to $@ $(RESET)"
# 	@echo "$(CYAN)ðŸ” Most Recent Changes in $< (by Time):$(RESET)"
# 	@# 1. git blameìœ¼ë¡œ ê° ì¤„ì˜ ìˆ˜ì •ì‹œê°„ì„ ê°€ì ¸ì˜´
# 	@# 2. ì‹œê°„ ìˆœì„œë¡œ ì—­ìˆœ ì •ë ¬(sort -r)
# 	@# 3. ê·¸ ì¤‘ ìƒìœ„ 5ì¤„ë§Œ ì„ íƒ(head -n 5)
# 	@git blame --incremental $< | grep -E "^author-time " | cut -d' ' -f2 > .tmp_times || true
# 	@git blame $< | sort -k3,3r | head -n 5 | sed 's/^/  [RECENT] /' || true
# 	@echo "$(CYAN)----------------------$(RESET)"
# 	@mkdir -p $(BUILDDIR)
# 	$(CC) $(CFLAGS) -c $< -o $@
# 	@echo "$(CYAN)OK$(RESET)"

#ì¤‘ê°„ì— ìƒì„±ëœ *.o *.bin *.elf ë“±ì„ ì‚­ì œí•œë‹¤.
clean: 
	@echo ""
	@echo "$(YELLOW)Clean build files... $(RESET)"
	@rm -rf $(BUILDDIR)
	@echo "$(CYAN)OK$(RESET)"
	@echo ""


debug:
	@echo ""
	@echo "$(SRCS)"
	@echo "$(OBJS)"
	@echo ""


# ì•„ëž˜ëŠ” ê·¸ëƒ¥ ë§¤ìš° ê°„ë‹¨í•œ ë²„ì „ì˜ Makefile
# all:
# 	@echo "compile main.c ......"
# 	arm-none-eabi-gcc -mcpu=cortex-m4 -mthumb -c main.c -o main.o
# 	@echo "\ncompile startup.c ......"
# 	arm-none-eabi-gcc -mcpu=cortex-m4 -mthumb -c startup.c -o startup.o
# 	@echo "\nlinking ......"
# 	arm-none-eabi-ld -T tm4c123.ld startup.o main.o -o final.elf
# 	@echo "\nobjcopy ......"
# 	arm-none-eabi-objcopy -O binary final.elf final.bin
# 	@echo "\ndownloading binary ......"
# 	sudo lm4flash final.bin
#
# down:
# 	@echo "\ndownloading binary ......"
# 	sudo lm4flash final.bin
#
# down/%:
# 	@echo "\ndownloading binary ......"
# 	sudo lm4flash $*

